<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Due Communications</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>AI Team Communications Agent</h1>
        <nav>
            <a href="{{ url_for('index') }}">Dashboard</a>
            <a href="{{ url_for('due_communications') }}">Due Communications</a>
            <a href="{{ url_for('create_project') }}">+ New Project</a>
        </nav>
    </header>

    <main>
        <section class="due-comms">
            <h2>Communications Due in Next 7 Days</h2>

            {% if due_communications %}
                <div class="due-comms-actions">
                    <button onclick="generateSelectedDrafts()" class="btn btn-primary">Generate Drafts for Selected</button>
                    <button onclick="selectAll()" class="btn btn-secondary">Select All</button>
                </div>

                <div class="due-comms-list">
                    {% for item in due_communications %}
                    <div class="due-comm-item">
                        <div class="due-comm-header">
                            <input type="checkbox" class="comm-checkbox"
                                   data-project-id="{{ item.project_id }}"
                                   data-comm='{{ item.planned_comm|tojson|safe }}'>
                            <div>
                                <h3>{{ item.project_name }}</h3>
                                <span class="days-badge {% if item.days_until_due <= 2 %}urgent{% elif item.days_until_due <= 5 %}warning{% endif %}">
                                    {% if item.days_until_due == 0 %}
                                        Due Today
                                    {% elif item.days_until_due == 1 %}
                                        Due Tomorrow
                                    {% else %}
                                        Due in {{ item.days_until_due }} days
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="due-comm-details">
                            <div class="detail-row">
                                <strong>Date:</strong> {{ item.planned_comm.target_date }}
                            </div>
                            <div class="detail-row">
                                <strong>Type:</strong>
                                <span class="type-badge">{{ item.planned_comm.type }}</span>
                            </div>
                            <div class="detail-row">
                                <strong>Audiences:</strong>
                                <div class="audience-tags">
                                    {% for audience in item.planned_comm.audiences %}
                                    <span class="audience-tag">{{ audience }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="detail-row">
                                <strong>Reason:</strong>
                                <p>{{ item.planned_comm.reason }}</p>
                            </div>
                            <div class="detail-row">
                                <strong>Key Topics:</strong>
                                <ul>
                                    {% for topic in item.planned_comm.key_topics %}
                                    <li>{{ topic }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div class="due-comm-actions">
                            <a href="{{ url_for('project_detail', project_id=item.project_id) }}" class="btn btn-secondary">View Project</a>
                            <button onclick="generateSingleDraft('{{ item.project_id }}', {{ item.planned_comm|tojson|safe }})"
                                    class="btn btn-primary">Generate Draft</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>No communications due in the next 7 days.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">Back to Dashboard</a>
                </div>
            {% endif %}
        </section>

        <div id="draftsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Review Email Drafts</h2>
                    <button onclick="closeModal()" class="close-btn">&times;</button>
                </div>
                <div id="draftsContainer" class="modal-body">
                    <!-- Drafts will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>AI Team Communications Agent - Powered by AWS Strands SDK</p>
    </footer>

    <script>
        let currentButton = null;

        function selectAll() {
            const checkboxes = document.querySelectorAll('.comm-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function generateSelectedDrafts() {
            const selected = Array.from(document.querySelectorAll('.comm-checkbox:checked'));

            if (selected.length === 0) {
                alert('Please select at least one communication');
                return;
            }

            const communications = selected.map(cb => ({
                project_id: cb.dataset.projectId,
                planned_comm: JSON.parse(cb.dataset.comm)
            }));

            generateDrafts(communications, event.target);
        }

        function generateSingleDraft(projectId, plannedComm) {
            generateDrafts([{
                project_id: projectId,
                planned_comm: plannedComm
            }], event.target);
        }

        function generateDrafts(communications, button) {
            currentButton = button;
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Generating with AI...';

            // Show loading notification
            showNotification('Generating email drafts using AI. This may take 10-30 seconds...', 'info');

            fetch('{{ url_for("generate_drafts") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ communications })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                button.disabled = false;
                button.textContent = originalText;

                if (data.success) {
                    showNotification(`Successfully generated ${data.drafts.length} email draft(s)!`, 'success');
                    showDraftsModal(data.drafts);
                } else {
                    showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error generating drafts:', error);
                showNotification('Error generating drafts: ' + error.message, 'error');
                button.disabled = false;
                button.textContent = originalText;
            });
        }

        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.5rem; padding: 0 0.5rem; margin-left: 1rem;">&times;</button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds for info/success, 10 seconds for error
            const timeout = type === 'error' ? 10000 : 5000;
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, timeout);
        }

        function showDraftsModal(drafts) {
            const container = document.getElementById('draftsContainer');
            container.innerHTML = '';

            if (drafts.length === 0) {
                container.innerHTML = '<p class="empty-state">No drafts were generated.</p>';
                document.getElementById('draftsModal').style.display = 'flex';
                return;
            }

            drafts.forEach((draft, index) => {
                // Escape HTML in draft content
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };

                const audienceBadgeColors = {
                    'users': 'background: #e8f4f8; color: #2980b9;',
                    'developers': 'background: #fef5e7; color: #d68910;',
                    'management': 'background: #f4ecf7; color: #8e44ad;'
                };

                const draftHtml = `
                    <div class="draft-item" id="draft-${index}">
                        <h3>
                            <span style="display: inline-block; padding: 0.25rem 0.8rem; border-radius: 12px; font-size: 0.85rem; ${audienceBadgeColors[draft.audience] || 'background: #ecf0f1; color: #2c3e50;'}">
                                ${draft.audience.charAt(0).toUpperCase() + draft.audience.slice(1)}
                            </span>
                            Email Draft
                        </h3>
                        <div class="draft-field">
                            <label>To: ${draft.audience}@company.com</label>
                        </div>
                        <div class="draft-field">
                            <label>Subject:</label>
                            <input type="text" id="subject-${index}" value="${escapeHtml(draft.subject)}" class="draft-input">
                        </div>
                        <div class="draft-field">
                            <label>Body:</label>
                            <textarea id="body-${index}" rows="15" class="draft-textarea">${escapeHtml(draft.body)}</textarea>
                        </div>
                        <div class="draft-field">
                            <label>Key Points Covered:</label>
                            <ul>
                                ${draft.key_points.map(point => `<li>${escapeHtml(point)}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="draft-actions">
                            <button onclick="sendEmail(${index}, ${index})" class="btn btn-primary">‚úì Approve & Send</button>
                            <button onclick="copyToClipboard(${index})" class="btn btn-secondary">üìã Copy to Clipboard</button>
                            <button onclick="removeDraft(${index})" class="btn btn-secondary">‚úó Reject</button>
                        </div>
                    </div>
                `;
                container.innerHTML += draftHtml;
            });

            // Store drafts data globally for later access
            window.currentDrafts = drafts;

            document.getElementById('draftsModal').style.display = 'flex';
        }

        function copyToClipboard(index) {
            const subject = document.getElementById(`subject-${index}`).value;
            const body = document.getElementById(`body-${index}`).value;
            const text = `Subject: ${subject}\n\n${body}`;

            navigator.clipboard.writeText(text).then(() => {
                showNotification('Draft copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy to clipboard', 'error');
                console.error('Copy failed:', err);
            });
        }

        function closeModal() {
            document.getElementById('draftsModal').style.display = 'none';
        }

        function removeDraft(index) {
            const draftItem = document.querySelectorAll('.draft-item')[index];
            draftItem.remove();

            if (document.querySelectorAll('.draft-item').length === 0) {
                closeModal();
            }
        }

        function sendEmail(index, draftIndex) {
            const subject = document.getElementById(`subject-${index}`).value;
            const body = document.getElementById(`body-${index}`).value;
            const draftData = window.currentDrafts[draftIndex];

            const emailData = {
                project_id: draftData.project_id,
                audience: draftData.audience,
                type: draftData.type,
                subject: subject,
                body: body,
                key_points: draftData.key_points,
                planned_comm_id: draftData.planned_comm_id
            };

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Sending...';

            fetch('{{ url_for("send_email") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(emailData)
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;

                if (data.success) {
                    showNotification('Email marked as sent and history updated!', 'success');
                    removeDraft(index);
                    // Reload page to update due communications if modal is empty
                    setTimeout(() => {
                        if (document.querySelectorAll('.draft-item').length === 0) {
                            window.location.reload();
                        }
                    }, 1000);
                } else {
                    showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                showNotification('Error sending email: ' + error.message, 'error');
                console.error('Send error:', error);
            });
        }
    </script>
</body>
</html>
